<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Lluvia de Palabras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #cde8ff;
      color: #f5f5f5;
      overflow: hidden;
    }
    button {
      font-family: inherit;
      cursor: pointer;
      border: none;
      outline: none;
    }
    #app {
      height: 100vh;
      width: 100vw;
      position: relative;
      overflow: hidden;
    }

    /* ===== PANTALLA DE INICIO ===== */

    #start-screen {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: radial-gradient(circle at top, rgba(255,255,255,0.8), rgba(135,206,250,0.4)),
                  linear-gradient(to bottom, #8fd3ff, #cde8ff);
      z-index: 10;
    }
    .start-card {
      max-width: 720px;
      width: 100%;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.6);
      overflow: hidden;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
    }
    @media (max-width: 768px) {
      .start-card { grid-template-columns: 1fr; }
    }

    .start-visual {
      position: relative;
      min-height: 220px;
      /* aqu√≠ puedes cambiar kayak-portada.jpg por el nombre real de tu imagen */
      background-image:
        linear-gradient(to bottom, rgba(15,23,42,0.2), rgba(15,23,42,0.75)),
        url("kayak-portada.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .start-content {
      padding: 20px 22px 22px 22px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(56, 189, 248, 0.15);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      color: #e0f2fe;
      align-self: flex-start;
    }
    .badge span {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }
    .start-title {
      font-size: 1.6rem;
      line-height: 1.25;
      color: #e5e7eb;
    }
    .start-sub {
      font-size: 0.95rem;
      color: #cbd5f5;
    }
    .start-quote {
      font-size: 0.9rem;
      color: #9ca3af;
      border-left: 3px solid rgba(148, 163, 184, 0.7);
      padding-left: 10px;
      margin-top: 4px;
    }
    .start-author {
      font-size: 0.85rem;
      color: #e5e7eb;
      margin-top: 10px;
    }
    .start-author span {
      display: block;
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 2px;
    }
    .start-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 25px rgba(22, 163, 74, 0.6);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(22, 163, 74, 0.7);
      filter: brightness(1.05);
    }
    .btn-secondary {
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
      padding: 9px 14px;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    /* ===== PANTALLA DE JUEGO ===== */

    #game-screen {
      position: absolute;
      inset: 0;
      display: none;
      flex-direction: column;
      background:
        linear-gradient(to bottom, #a6ddff, #6cbcff 55%, #bbf7d0 70%, #166534 100%);
    }
    #game-screen.paused {
      filter: grayscale(0.2) brightness(0.85);
    }

    /* Arco√≠ris lejano */
    #rainbow-band {
      position: absolute;
      top: 8%;
      left: -10%;
      width: 120%;
      height: 12%;
      background: linear-gradient(
        to right,
        rgba(255, 0, 0, 0.7),
        rgba(255, 165, 0, 0.7),
        rgba(255, 255, 0, 0.7),
        rgba(0, 128, 0, 0.7),
        rgba(0, 0, 255, 0.7),
        rgba(75, 0, 130, 0.7),
        rgba(238, 130, 238, 0.8)
      );
      opacity: 0.5;
      filter: blur(6px);
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 12px;
      position: relative;
      z-index: 2;
    }
    .score-pill {
      background: linear-gradient(to right, #f97316, #facc15, #22c55e);
      color: #111827;
      padding: 6px 20px;
      border-radius: 999px;
      font-size: 0.85rem;
      display: inline-flex;
      gap: 14px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.7);
    }
    .score-pill span strong { font-weight: 700; }

    #mic-toggle {
      position: absolute;
      right: 14px;
      top: 9px;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 2px solid rgba(248, 250, 252, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.8);
    }
    #mic-toggle span { font-size: 1.1rem; }
    #mic-toggle.listening {
      border-color: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.4);
      background: radial-gradient(circle at center, #22c55e, #15803d);
      color: #ecfdf5;
    }

    #menu-button {
      position: absolute;
      left: 12px;
      top: 10px;
      z-index: 7;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.8);
    }
    #menu-button span { font-size: 1.2rem; }

    #play-area {
      position: relative;
      flex: 1;
      overflow: hidden;
      z-index: 1;
    }

    .word {
      position: absolute;
      padding: 6px 10px;
      background: rgba(15, 23, 42, 0.92);
      border-radius: 999px;
      font-size: 1rem;
      color: #f9fafb;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.9);
      white-space: nowrap;
      border: 1px solid rgba(148, 163, 184, 0.8);
      transform-origin: center;
    }
    .word.pop {
      animation: popOut 0.15s ease-out forwards;
    }
    @keyframes popOut {
      0%   { transform: scale(1); opacity: 1; }
      60%  { transform: scale(1.25); opacity: 1; }
      100% { transform: scale(0.4); opacity: 0; }
    }

    /* Suelo / jard√≠n de estrellas */

    #bottom-bar {
      position: relative;
      padding: 6px 14px 10px 14px;
      font-size: 0.8rem;
      color: #e5e7eb;
      z-index: 2;
      background: linear-gradient(to bottom, rgba(22, 101, 52, 0.2), rgba(22, 101, 52, 0.9));
      box-shadow: 0 -6px 18px rgba(15, 23, 42, 0.7);
    }
    #bottom-bar-title {
      font-size: 0.78rem;
      opacity: 0.9;
    }
    .stars-bar {
      position: relative;
      height: 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      overflow: hidden;
      margin-top: 4px;
      border: 1px solid rgba(34,197,94,0.5);
    }
    .stars-fill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0%;
      background: linear-gradient(to right, #facc15, #f97316, #22c55e);
      transition: width 0.25s ease-out;
    }
    #mic-status {
      margin-top: 4px;
      font-size: 0.75rem;
      color: #d1fae5;
    }

    /* Panel lateral */

    #side-panel {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      max-width: 80%;
      background: rgba(15, 23, 42, 0.98);
      box-shadow: 10px 0 30px rgba(15, 23, 42, 0.9);
      transform: translateX(-100%);
      transition: transform 0.22s ease-out;
      padding: 60px 10px 10px 10px;
      z-index: 6;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 0.8rem;
      overflow-y: auto; /* para ver todas las secciones */
    }
    #side-panel.open { transform: translateX(0); }
    .panel-section {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
    }
    .panel-title {
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      color: #e5e7eb;
      margin-bottom: 4px;
    }
    .panel-sub {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .panel-section textarea {
      width: 100%;
      min-height: 80px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
      padding: 6px;
      font-size: 0.78rem;
      resize: vertical;
    }
    .panel-buttons {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    .btn-small {
      flex: 1;
      border-radius: 999px;
      padding: 4px 6px;
      font-size: 0.72rem;
      background: rgba(31, 41, 55, 0.9);
      color: #e5e7eb;
      border: 1px solid rgba(75, 85, 99, 0.9);
      cursor: pointer;
    }
    .btn-small.primary {
      background: #22c55e;
      border-color: #16a34a;
      color: #022c22;
      font-weight: 600;
    }
    .slider-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .slider-row input[type="range"] { flex: 1; }

    .panel-help-list {
      list-style: disc;
      padding-left: 16px;
      color: #9ca3af;
      font-size: 0.72rem;
    }

    .record-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .record-row .btn-small {
      flex: 1;
      text-align: center;
    }
    #recording-player {
      width: 100%;
      margin-top: 4px;
    }

    .select-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }
    .select-row select {
      flex: 1;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      padding: 4px 6px;
      font-size: 0.76rem;
    }

    /* Confeti */

    .confetti-piece {
      position: fixed;
      width: 6px;
      height: 10px;
      border-radius: 2px;
      opacity: 0.9;
      pointer-events: none;
      animation: confetti-fall 0.7s ease-out forwards;
      z-index: 50;
    }
    @keyframes confetti-fall {
      0% { transform: translate3d(0,0,0) rotateZ(0deg); }
      100% {
        transform: translate3d(var(--x-move), 60px, 0) rotateZ(360deg);
        opacity: 0;
      }
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
<div id="app">

  <!-- PANTALLA DE INICIO -->
  <section id="start-screen">
    <div class="start-card">
      <div class="start-visual"></div>
      <div class="start-content">
        <div class="badge">
          <span></span>
          Lectoras y lectores en voz alta
        </div>
        <h1 class="start-title">Lluvia de Palabras</h1>
        <p class="start-sub">
          Un juego sencillo para leer en voz alta, mejorar la atenci√≥n y fortalecer el h√°bito lector
        </p>
        <p class="start-quote">
          ¬´La lectura es, probablemente, una de las formas m√°s silenciosas del desarrollo humano.¬ª
        </p>
        <p class="start-author">
          Creado por: <strong>Andr√©s L. Belluga</strong>
          <span>Con la colaboraci√≥n de Andr√©s y Ana</span>
        </p>
        <div class="start-actions">
          <button id="btn-start" class="btn-primary">
            Empezar a jugar <span>‚ñ∂</span>
          </button>
          <button class="btn-secondary" type="button">
            Versi√≥n inicial ¬∑ modo lluvia
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- PANTALLA DE JUEGO -->
  <section id="game-screen">
    <div id="rainbow-band"></div>

    <button id="menu-button" title="Abrir panel de control">
      <span>‚ò∞</span>
    </button>

    <div class="top-bar">
      <div class="score-pill">
        <span>Puntos: <strong id="score">0</strong></span>
        <span>Racha: <strong id="streak">0</strong></span>
        <span>Modo: <strong>Lluvia</strong></span>
      </div>
      <button id="mic-toggle" title="Activar / desactivar micr√≥fono">
        <span>üé§</span>
      </button>
    </div>

    <div id="play-area"></div>

    <div id="bottom-bar">
      <div id="bottom-bar-title">Cielo de estrellas</div>
      <div class="stars-bar">
        <div class="stars-fill" id="stars-fill"></div>
      </div>
      <div id="mic-status">Micr√≥fono apagado. Pulsa üé§ para activarlo.</div>
    </div>

    <aside id="side-panel">
      <div class="panel-section">
        <div class="panel-title">Idioma</div>
        <div class="panel-sub">Selecciona el idioma del reconocimiento de voz.</div>
        <div class="select-row">
          <select id="language-select">
            <option value="es-ES">Espa√±ol</option>
            <option value="en-GB">Ingl√©s</option>
          </select>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-title">Modo y nivel</div>
        <div class="panel-sub">Elige el tipo de lectura y la dificultad.</div>
        <div class="select-row">
          <select id="mode-select">
            <option value="palabras">Palabras</option>
            <option value="frases">Frases</option>
            <option value="fragmentos">Fragmentos</option>
          </select>
          <select id="level-select">
            <option value="1">Nivel 1</option>
            <option value="2">Nivel 2</option>
            <option value="3">Nivel 3</option>
          </select>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-title">Velocidad</div>
        <div class="panel-sub">Tiempo de ca√≠da (1 = m√°s lento ¬∑ 5 = m√°s r√°pido)</div>
        <div class="slider-row">
          <input type="range" id="speed-slider" min="1" max="5" value="3" />
          <span id="speed-label">3</span>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-title">Palabras / frases visibles</div>
        <div class="panel-sub">
          Lista actual (una l√≠nea por elemento). Puedes editarla y pulsar ‚ÄúUsar estas‚Äù.
        </div>
        <textarea id="words-input"></textarea>
        <div class="panel-buttons">
          <button id="btn-load-default" class="btn-small">Recargar modo/nivel</button>
          <button id="btn-use-custom" class="btn-small primary">Usar estas</button>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-title">Grabaci√≥n</div>
        <div class="panel-sub">
          Graba una frase para que el peque pueda escucharse. Mientras grabas, el juego se pausa.
        </div>
        <div class="record-row">
          <button id="btn-record" class="btn-small primary">Grabar</button>
          <button id="btn-stop-record" class="btn-small" disabled>Parar</button>
        </div>
        <audio id="recording-player" controls></audio>
      </div>

      <div class="panel-section">
        <div class="panel-title">Ayuda r√°pida</div>
        <ul class="panel-help-list">
          <li>El panel pausa el juego al abrirse.</li>
          <li>Pulsa üé§ para que las palabras exploten al decirlas.</li>
          <li>Funciona en ordenador y m√≥vil (vertical u horizontal).</li>
          <li>Puedes cambiar modo, nivel y lista en cualquier momento.</li>
        </ul>
      </div>
    </aside>
  </section>
</div>

<script>
(function() {
  const startScreen = document.getElementById("start-screen");
  const gameScreen = document.getElementById("game-screen");
  const btnStart = document.getElementById("btn-start");
  const menuButton = document.getElementById("menu-button");
  const sidePanel = document.getElementById("side-panel");
  const playArea = document.getElementById("play-area");
  const scoreEl = document.getElementById("score");
  const streakEl = document.getElementById("streak");
  const starsFill = document.getElementById("stars-fill");
  const micToggle = document.getElementById("mic-toggle");
  const micStatus = document.getElementById("mic-status");
  const speedSlider = document.getElementById("speed-slider");
  const speedLabel = document.getElementById("speed-label");
  const wordsInput = document.getElementById("words-input");
  const btnLoadDefault = document.getElementById("btn-load-default");
  const btnUseCustom = document.getElementById("btn-use-custom");
  const btnRecord = document.getElementById("btn-record");
  const btnStopRecord = document.getElementById("btn-stop-record");
  const recordingPlayer = document.getElementById("recording-player");
  const languageSelect = document.getElementById("language-select");
  const modeSelect = document.getElementById("mode-select");
  const levelSelect = document.getElementById("level-select");

  let isRunning = false;
  let isPaused = false;
  let score = 0;
  let streak = 0;
  let starsProgress = 0;
  let activeWords = [];
  let spawnIntervalId = null;
  let moveIntervalId = null;
  let currentWordList = [];

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let micOn = false;

  let mediaRecorder = null;
  let recordedChunks = [];
  let wasMicOnBeforeRecording = false;

  const contentSets = {
    "palabras-1": [
      "sol","luz","nube","mar","r√≠o","tren","flor","cielo","gato","√°rbol"
    ],
    "palabras-2": [
      "ventana","camino","nieve","puente","maleta","carrito","cuento","playa","camiseta","monta√±a"
    ],
    "palabras-3": [
      "mariposa","cascabel","farolillo","piruleta","barquito","sombrerito","jardiner√≠a","bicicleta","murmullo","br√∫jula"
    ],
    "frases-1": [
      "leo en voz alta",
      "veo el sol",
      "la nube pasa",
      "salta la rana",
      "corre el tren"
    ],
    "frases-2": [
      "una flor mira al cielo",
      "la luna escucha en silencio",
      "tres hojas bailan despacio",
      "una piedra guarda secretos",
      "el r√≠o canta suave"
    ],
    "frases-3": [
      "el gato duerme sobre el tejado azul",
      "un barco peque√±o sue√±a con mares lejanos",
      "la tarde se llena de pasos y risas",
      "la ciudad enciende sus luces despacio",
      "un abrazo detiene el ruido del mundo"
    ],
    "fragmentos-1": [
      "Hab√≠a una vez un ni√±o que miraba la lluvia caer.",
      "En la casa de la colina siempre ol√≠a a pan reci√©n hecho.",
      "El perro mov√≠a la cola cada vez que ve√≠a la mochila."
    ],
    "fragmentos-2": [
      "Todas las noches alguien contaba una historia distinta, aunque nadie recordaba el principio.",
      "El autob√∫s avanzaba despacio y la ventana era un cine silencioso de √°rboles y coches."
    ],
    "fragmentos-3": [
      "En el parque, las conversaciones se mezclaban con el ruido de las hojas y el crujido de las bicicletas sobre la grava.",
      "A veces, bastaba con leer una sola l√≠nea para que todo el d√≠a cambiara de color, como si alguien encendiera una luz desde dentro."
    ]
  };

  function normalize(text) {
    return text
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z√±\s]/g, " ")
      .trim();
  }

  function getKeyForSelection() {
    const mode = modeSelect.value;
    const level = levelSelect.value;
    return mode + "-" + level;
  }

  function applyModeLevelToWordsBox() {
    const key = getKeyForSelection();
    const list = contentSets[key] || [];
    currentWordList = list.slice();
    wordsInput.value = list.join("\n");
  }

  function setInitialWords() {
    applyModeLevelToWordsBox();
  }

  /* ===== JUEGO ===== */

  function startGame() {
    startScreen.style.display = "none";
    gameScreen.style.display = "flex";
    resetGame();
    isRunning = true;
    isPaused = false;
    gameScreen.classList.remove("paused");
  }

  function resetGame() {
    score = 0;
    streak = 0;
    starsProgress = 0;
    updateScore();
    updateStars();

    clearWords();
    if (!currentWordList || currentWordList.length === 0) {
      applyModeLevelToWordsBox();
    }

    if (spawnIntervalId) clearInterval(spawnIntervalId);
    if (moveIntervalId) clearInterval(moveIntervalId);

    const spawnMs = 2600;
    spawnIntervalId = setInterval(() => {
      if (isPaused || !isRunning) return;
      spawnWord();
    }, spawnMs);

    moveIntervalId = setInterval(() => {
      if (isPaused || !isRunning) return;
      moveWords();
    }, 35);
  }

  function clearWords() {
    activeWords.forEach(w => {
      if (w.el && w.el.parentNode) w.el.parentNode.removeChild(w.el);
    });
    activeWords = [];
  }

  function spawnWord() {
    if (!currentWordList || currentWordList.length === 0) return;

    const text = currentWordList[Math.floor(Math.random() * currentWordList.length)];
    const el = document.createElement("div");
    el.className = "word";
    el.textContent = text;

    const areaRect = playArea.getBoundingClientRect();
    const wordWidth = 130;
    const x = Math.random() * Math.max(10, areaRect.width - wordWidth - 20);
    const y = -40;

    el.style.left = x + "px";
    el.style.top = y + "px";

    playArea.appendChild(el);

    const speed = parseInt(speedSlider.value, 10) || 3;

    activeWords.push({
      text,
      norm: normalize(text),
      x,
      y,
      speed,
      el
    });
  }

  function moveWords() {
    const areaRect = playArea.getBoundingClientRect();
    const baseStep = 0.9;
    activeWords.slice().forEach((wordObj) => {
      wordObj.y += baseStep * wordObj.speed;
      if (wordObj.el) {
        wordObj.el.style.top = wordObj.y + "px";
      }
      if (wordObj.y > areaRect.height + 20) {
        removeWord(wordObj, false);
        streak = 0;
        updateScore();
      }
    });
  }

  function updateScore() {
    scoreEl.textContent = score;
    streakEl.textContent = streak;
  }

  function updateStars() {
    if (starsProgress < 0) starsProgress = 0;
    if (starsProgress > 100) starsProgress = 100;
    starsFill.style.width = starsProgress + "%";
  }

  function removeWord(wordObj, addScore) {
    const idx = activeWords.indexOf(wordObj);
    if (idx !== -1) activeWords.splice(idx, 1);
    if (wordObj.el && wordObj.el.parentNode) {
      wordObj.el.classList.add("pop");
      setTimeout(() => {
        if (wordObj.el && wordObj.el.parentNode) {
          wordObj.el.parentNode.removeChild(wordObj.el);
        }
      }, 120);
    }
    if (addScore) {
      score += 10;
      streak += 1;
      starsProgress += 4;
      updateScore();
      updateStars();
    }
  }

  /* ===== MICR√ìFONO PARA EXPLOTAR PALABRAS ===== */

  function setupRecognition() {
    if (!SpeechRecognition) {
      micStatus.textContent = "Este navegador no admite reconocimiento de voz. Prueba con Chrome.";
      micToggle.disabled = true;
      return;
    }
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true; // resultados parciales
    recognition.lang = languageSelect.value || "es-ES";

    recognition.onresult = (event) => {
      if (!isRunning || isPaused) return;
      const last = event.results[event.results.length - 1];
      if (!last || !last[0]) return;
      const transcript = normalize(last[0].transcript || "");
      if (!transcript) return;

      activeWords.slice().forEach(wordObj => {
        if (transcript.includes(wordObj.norm)) {
          const rect = wordObj.el.getBoundingClientRect();
          createConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2);
          removeWord(wordObj, true);
        }
      });
    };

    recognition.onend = () => {
      if (micOn) {
        try { recognition.start(); } catch (e) {}
      }
    };

    recognition.onerror = () => {
      micStatus.textContent = "Error con el micr√≥fono. Prueba a desactivar y activar de nuevo.";
    };
  }

  function restartRecognitionLanguage() {
    if (!recognition) return;
    const wasOn = micOn;
    if (wasOn) {
      micOn = false;
      recognition.stop();
    }
    recognition.lang = languageSelect.value || "es-ES";
    if (wasOn) {
      micOn = true;
      try { recognition.start(); } catch (e) {}
    }
  }

  function toggleMic() {
    if (!SpeechRecognition) return;
    micOn = !micOn;
    if (micOn) {
      try { recognition.start(); } catch (e) {}
      micToggle.classList.add("listening");
      micStatus.textContent = "Micr√≥fono escuchando. Di la palabra que cae.";
    } else {
      recognition.stop();
      micToggle.classList.remove("listening");
      micStatus.textContent = "Micr√≥fono apagado. Pulsa üé§ para activarlo.";
    }
  }

  /* ===== GRABACI√ìN DE VOZ ===== */

  function startRecording() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert("Este navegador no permite grabar audio.");
      return;
    }

    if (!isPaused) {
      openPanel();
    }
    wasMicOnBeforeRecording = micOn;
    if (micOn) {
      micOn = false;
      recognition && recognition.stop();
      micToggle.classList.remove("listening");
    }

    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        try {
          mediaRecorder = new MediaRecorder(stream);
        } catch (e) {
          alert("No se ha podido iniciar la grabaci√≥n.");
          stream.getTracks().forEach(t => t.stop());
          return;
        }
        recordedChunks = [];
        mediaRecorder.ondataavailable = e => {
          if (e.data && e.data.size > 0) recordedChunks.push(e.data);
        };
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "audio/webm" });
          recordingPlayer.src = URL.createObjectURL(blob);
          stream.getTracks().forEach(t => t.stop());
        };
        mediaRecorder.start();
        btnRecord.disabled = true;
        btnStopRecord.disabled = false;
        micStatus.textContent = "Grabando voz‚Ä¶ El juego est√° en pausa.";
      })
      .catch(() => {
        alert("No se ha podido acceder al micr√≥fono para grabar.");
      });
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
      mediaRecorder = null;
      btnRecord.disabled = false;
      btnStopRecord.disabled = true;
      micStatus.textContent = "Grabaci√≥n terminada. Puedes reproducirla abajo.";
      if (wasMicOnBeforeRecording && SpeechRecognition) {
        micOn = true;
        try { recognition.start(); } catch (e) {}
        micToggle.classList.add("listening");
        micStatus.textContent += " Micr√≥fono de juego reactivado.";
      }
    }
  }

  /* ===== CONFETI ===== */

  function createConfetti(x, y) {
    const colors = ["#facc15","#f97316","#22c55e","#38bdf8","#e879f9","#f472b6"];
    const count = 20;
    for (let i = 0; i < count; i++) {
      const piece = document.createElement("div");
      piece.className = "confetti-piece";
      const angle = Math.random() * Math.PI * 2;
      const distance = 40 + Math.random() * 40;
      const dx = Math.cos(angle) * distance;
      piece.style.setProperty("--x-move", dx + "px");
      piece.style.left = x + "px";
      piece.style.top = y + "px";
      piece.style.background = colors[i % colors.length];
      document.body.appendChild(piece);
      setTimeout(() => {
        if (piece.parentNode) piece.parentNode.removeChild(piece);
      }, 680);
    }
  }

  /* ===== PANEL / PAUSA ===== */

  function openPanel() {
    sidePanel.classList.add("open");
    isPaused = true;
    gameScreen.classList.add("paused");
  }
  function closePanel() {
    sidePanel.classList.remove("open");
    isPaused = false;
    gameScreen.classList.remove("paused");
  }

  /* ===== EVENTOS ===== */

  btnStart.addEventListener("click", startGame);

  menuButton.addEventListener("click", (e) => {
    e.stopPropagation();
    if (sidePanel.classList.contains("open")) {
      closePanel();
    } else {
      openPanel();
    }
  });

  gameScreen.addEventListener("click", (e) => {
    if (!sidePanel.classList.contains("open")) return;
    if (sidePanel.contains(e.target)) return;
    if (menuButton.contains(e.target)) return;
    closePanel();
  });

  speedSlider.addEventListener("input", () => {
    speedLabel.textContent = speedSlider.value;
    const val = parseInt(speedSlider.value, 10) || 3;
    activeWords.forEach(w => w.speed = val);
  });

  btnLoadDefault.addEventListener("click", () => {
    applyModeLevelToWordsBox();
    resetGame();
  });

  btnUseCustom.addEventListener("click", () => {
    const lines = wordsInput.value.split(/\r?\n/).map(l => normalize(l)).filter(Boolean);
    if (lines.length === 0) {
      applyModeLevelToWordsBox();
    } else {
      currentWordList = lines;
    }
    resetGame();
  });

  micToggle.addEventListener("click", toggleMic);

  btnRecord.addEventListener("click", startRecording);
  btnStopRecord.addEventListener("click", stopRecording);

  languageSelect.addEventListener("change", () => {
    restartRecognitionLanguage();
  });

  modeSelect.addEventListener("change", () => {
    applyModeLevelToWordsBox();
    resetGame();
  });

  levelSelect.addEventListener("change", () => {
    applyModeLevelToWordsBox();
    resetGame();
  });

  setInitialWords();
  setupRecognition();
})();
</script>
</body>
</html>



